# 読書メモアプリ 設計ドキュメント

## 1. アプリの目的・概要
- スマホ・PC両対応のレスポンシブWebアプリ（PWA化も可能）
- 書籍やWebページなど、ISBNの有無を問わず管理
- 本を読みながら、OCRやバーコードスキャン、画像添付でメモや感想を記録
- 全文検索で過去のメモや書籍情報を横断的に検索
- ユーザー認証（個人利用・複数ユーザー対応）

## 2. 技術スタック
- フロントエンド：React（Vite推奨）、React Router、Material-UI等
- データベース：Firebase Firestore
- 画像保存：Firebase Storage
- 認証：Firebase Authentication（メール＋パスワード）
- OCR：Tesseract.js（クライアントサイド）
- バーコードスキャン：zxing-js/library
- デプロイ：GitHub Pages または Firebase Hosting（無料枠で運用可能）

## 3. 主な機能
### 3.1 書籍・資料管理
- ISBNバーコードスキャン or 手入力で書籍登録
- ISBNから書誌情報（タイトル・著者・出版社・出版年月・書影）を自動取得（Google Books APIやOpenBD利用）
- ISBNの無い資料もタイトル・著者・URL等で登録可能
- 「読書中」「読了」などのステータス管理

### 3.2 メモ・感想管理
- 書籍ごとに複数のメモ（引用＋感想）を追加可能
- メモにはOCRテキスト、感想、ページ番号を保存可能
- メモ追加時にOCRテキスト入力が可能

### 3.3 検索・一覧
- 書籍タイトル・著者名・メモ内容・感想・OCRテキスト等を対象に全文検索
- Firestoreのクエリ＋クライアント側フィルタで十分対応可能（規模が大きくなればAlgolia等も検討）

### 3.4 認証・ユーザー管理
- Firebase Authenticationでユーザーごとにデータを分離
- 複数ユーザーでの利用も可能
- Firestoreのセキュリティルールで「自分のデータだけ閲覧・編集」できるよう制御

### 3.5 PWA対応
- スマホのホーム画面に追加、オフライン動作、カメラ・ストレージ利用もOK

## 4. データ構造（例）
### 書籍（booksコレクション）
```json
{
  "id": "自動生成ID",
  "userId": "ユーザーID",
  "isbn": "978-4-xx-xxxxxx-x", // 無い場合はnull
  "title": "タイトル",
  "author": "著者",
  "publisher": "出版社",
  "publishedDate": "2024-01-01",
  "coverUrl": "https://...",
  "status": "reading" or "finished",
  "url": "https://...", // Webページの場合
  "createdAt": "...",
  "updatedAt": "..."
}
```

### メモ（各書籍のサブコレクションmemos）
```json
{
  "id": "自動生成ID",
  "text": "OCRや引用テキスト",
  "comment": "感想",
  "page": 123,
  "createdAt": "..."
}
```

## 5. 画面・UI構成
- ログイン画面（新規登録・パスワードリセット）
- 本の一覧画面（読書中・読了タブ、サムネイル・タイトル・著者表示、追加ボタン）
- 本の追加画面（ISBN入力・バーコードスキャン・自動取得・手入力）
- 本の詳細画面（書影・書誌情報・**この本に紐づくメモ一覧**・メモ追加ボタン・ステータス変更）
  - **本の詳細画面では、その書籍に紐づく全メモを一覧表示し、各メモをクリック/タップでメモ詳細画面に遷移できる。**
- メモ追加画面（OCR→感想・ページ番号入力）
- メモ詳細画面（引用・感想・編集・削除）
- 全文検索画面（書籍・メモ横断検索）
- 検索・タグページ（ボトムナビ「検索・タグ」）の役割案
- 設定画面（アカウント情報・ログアウト・データエクスポート等）

## 6. 画面遷移・ナビゲーション
- スマホ：ボトムタブナビゲーション（本一覧・検索・設定）＋トップバー＋ハンバーガーメニュー
- PC：トップバーやサイドバーで主要機能にアクセス
- 主要画面間はタブやメニューで遷移、詳細・追加はボタンやリンクで遷移

### 画面遷移例（書籍とメモ）

```mermaid
graph TD
  A["本の一覧画面"] --> B["本の詳細画面（メモ一覧含む）"]
  B --> C["メモ詳細画面"]
  B --> D["メモ追加画面"]
```

- 本の一覧 → 本の詳細（その本のメモ一覧） → メモ詳細 or メモ追加

## 7. 運用・デプロイ
- GitHub PagesまたはFirebase Hostingで無料公開
- 各アプリは独立したリポジトリで管理し、ルーティングの衝突を防ぐ
- Firebase Authenticationで個人・複数ユーザー対応
- Cursorで開発・テスト・デプロイまで一貫サポート可能

## 8. テスト・開発運用
- React Testing Library＋Jestでユニットテスト
- テストコードもCursorで自動生成・修正可能
- 設計ドキュメント（本ファイル）を常に参照し、開発再開時の指針とする
- **CypressによるE2Eテストは「1ファイル＝1シナリオ（単体実行）」運用とし、テストごとに状態が独立するように設計する。複数テストの一括実行も可能だが、基本は個別実行・独立性重視とする。**

## 9. 開発・公開・運用方針（ステージング環境と本番環境）

### 9.1 開発中の非公開運用
- 開発中はGitHubリポジトリをprivateにしておき、外部にコードやアプリを公開しない。
- Firebase HostingやGitHub Pages等も、デプロイしない限りWeb上で公開されない。
- 公開前に十分な動作確認・テストを行う。

### 9.2 公開後の運用（ステージング環境の活用）
- 本番環境（production）とステージング環境（staging/preview）を分けて運用する。
- ステージング環境で新機能や修正の動作確認・テストを行い、問題なければ本番環境に反映する。

#### Firebase Hostingの場合
- `firebase.json`で本番用とステージング用の2つのターゲットを設定可能。
- 例：
  - 本番: `https://your-app.web.app`
  - ステージング: `https://staging-your-app.web.app`
- `firebase deploy --only hosting:staging` でステージング環境にデプロイ。
- `firebase deploy --only hosting:production` で本番環境にデプロイ。

#### GitHub Pagesの場合
- 本番用は`main`ブランチ、ステージング用は`staging`や`gh-pages`ブランチ等で運用可能。
- 必要に応じて別リポジトリやサブディレクトリでステージングページを作成。

#### Vercel/Netlifyの場合
- プルリクエストやブランチごとに自動でプレビューURL（ステージング）が発行される。
- 本番公開は`main`ブランチへのマージ時のみ。

### 9.3 運用の推奨事項
- 修正や新機能追加時は、まずステージング環境で十分にテスト・確認を行う。
- 問題がなければ本番環境に反映（デプロイ）する。
- Cursorもこの運用方針に従い、常に安全な開発・公開をサポートする。

## 10. 開発環境・コマンドシェルの前提

- 本プロジェクトの開発・運用時は、**Windows PowerShell** を標準のコマンドシェルとする。
- コマンド例やスクリプト、環境変数の指定方法もPowerShell前提で記載・運用する。
- 他のシェル（bash等）を使う場合は、適宜コマンドの書き換えが必要。

## 【制約事項・今後の拡張】

- 2024年10月以降、Firebase Storageの無料枠（Sparkプラン）では新規バケット作成ができないため、画像添付・画像アップロード機能は現時点で実装しない。
- 画像添付機能は将来的にBlazeプラン移行や他サービス利用時に拡張可能とする。

---

※このARCHITECTURE.mdは、開発を中断・再開する際にCursorが設計・要件を再確認できるようにまとめています。 

### 検索・タグページ（ボトムナビ「検索・タグ」）の役割案
- タグ管理・タグ一覧（ユーザーが登録したタグのリストアップ、タグごとの本・メモ件数表示、タグクリックで該当一覧へ遷移）
- タグの編集・削除機能（必要に応じて）
- タグの使用履歴からのサジェスト・補完入力（タグ入力時のUX向上）
- 高度な検索（複数タグ・著者・期間などの複合条件での絞り込み）
- タグの可視化・分析（使用頻度グラフやワードクラウド等）
- タグの一括付与・編集やサジェスト機能 