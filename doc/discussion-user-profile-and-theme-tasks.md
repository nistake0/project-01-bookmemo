# ユーザーデータ（プロフィール）とテーマのタスク分離について

**作成日**: 2025年1月31日  
**目的**: ユーザーデータ管理（プロフィール・設定）とテーマ選択機能のタスク境界を整理し、実装順序を提案する

---

## ⚠️ プロジェクト最優先目標（2025-01-31 決定）

**このドキュメントに記載されたタスクは、本プロジェクトの最優先目標です。**

開発を進める際は、以下を遵守してください：
- **開発開始時**: このドキュメントを必ず確認する
- **実装方針**: このドキュメントのタスク定義・順序に従う
- **設計判断**: ユーザーデータ・テーマ関連の判断はこのドキュメントを参照する

**確認が求められるタイミング**:
- 新しい開発セッションを開始するとき
- 新機能の実装を開始する前
- ユーザー設定・プロフィール・テーマに関連する作業を行うとき

---

## 1. 背景と問題意識

テーマ選択をユーザーごとに記憶するには、Firestore の `users/{userId}` に設定を保存する必要がある。一方で、ユーザーデータには以下のような情報が含まれる想定である：

- **プロフィール**: 表示名、アバター、自己紹介 等
- **設定・嗜好**: テーマ、通知設定、表示設定 等

テーマを単独で実装するか、プロフィール・ユーザーデータ管理の一環として実装するか、タスクの切り方が問われている。

---

## 2. 現状の整理

### 2.1 既存のユーザー関連

| 項目 | 現状 |
|------|------|
| **Firestore users/{userId}** | 存在。`bookTagHistory`, `memoTagHistory` のサブコレクションのみ使用 |
| **マイページ / プロフィール** | Phase 15-4 として計画済み。未実装 |
| **ボトムナビの PersonIcon** | 存在するが、対応ルート未定義 |
| **Firebase Auth user** | `email`, `displayName`, `uid` 等を利用可能 |

### 2.2 ユーザーデータとして想定しうるもの

| カテゴリ | 例 | 保存先候補 |
|---------|-----|-----------|
| **プロフィール** | 表示名、アバターURL、自己紹介 | Firestore users/{uid} |
| **設定・嗜好** | テーマ、通知ON/OFF、フォントサイズ等 | Firestore users/{uid} |
| **認証情報** | メール、UID | Firebase Auth（既存） |

---

## 3. 議論：テーマをどこに位置づけるか

### 3.1 テーマ単独タスクの問題

- Firestore に `themePresetId` だけを保存する最小実装は可能
- ただし、将来的にプロフィールやその他設定を追加する際、**データ構造の二重定義・マイグレーション**が発生しうる
- 設定を変更する **UI の置き場所** が不明確（テーマ専用ダイアログか、プロフィール内か）

### 3.2 プロフィールに含める場合の利点

- **一元的な設定場所**: テーマ、プロフィール、その他設定を「ユーザー設定」としてまとめられる
- **データ構造の一貫性**: `users/{uid}` のスキーマを一度設計すれば、テーマも含めて拡張しやすい
- **UI の一貫性**: マイページ（設定画面）にテーマ選択を含めることで、ユーザーが「設定はここ」と認識しやすい

### 3.3 プロフィールを先に作る場合の課題

- マイページ（プロフィール）は、従来から別タスク（Phase 15-4）として計画されている
- プロフィールをフル実装してからテーマに手を付けると、**テーマ実装が遅れる**
- プロフィールの範囲をどこまでとするか（表示名だけか、アバター等も含むか）の設計が必要

---

## 4. 提案：タスク分離と実装順序

### 4.1 タスクの境界

| タスク | 範囲 | 依存関係 |
|--------|------|---------|
| **A. ユーザー設定の基盤** | データ構造設計、取得・保存フック、設定画面の土台 | なし |
| **B. テーマ選択機能** | テーマプリセット、適用ロジック、選択UI | タスクA |
| **C. プロフィール機能** | 表示名、アバター等の表示・編集 | タスクA |

**ポイント**:  
- **タスクA** を「ユーザーデータ管理の基盤」とし、テーマもプロフィールもここに乗せる  
- タスクA では、**データ構造とフックだけ** を整備し、最初に保存するのは `themePresetId` のみでもよい  
- タスクB（テーマ）とタスクC（プロフィール）は、タスクA の上に並列で実装可能

### 4.2 推奨実装順序

```
1. タスクA: ユーザー設定の基盤整備
   - Firestore users/{userId} のスキーマ設計（profile, preferences 等）
   - useUserSettings フック（取得・保存・更新）
   - 設定画面の土台（マイページ or 設定モーダル）
   - 初回は themePresetId のみ利用（他はプレースホルダーでも可）

2. タスクB: テーマ選択機能
   - テーマプリセット定義、テーマファクトリ
   - useUserSettings から themePresetId を読んで ThemeProvider に渡す
   - テーマ選択UI をタスクA の設定画面に配置
   - デザイン一元化（パレット参照への置換）との並行も可

3. タスクC: プロフィール機能
   - 表示名、アバター等の表示・編集
   - タスクA の設定画面にプロフィールセクションを追加
```

### 4.3 タスクA のデータ構造案

```javascript
// Firestore users/{userId}
{
  // プロフィール（タスクC で拡張）
  profile: {
    displayName: '',
    avatarUrl: '',
    // 将来: bio, ...
  },
  
  // 設定・嗜好（タスクB で theme を利用）
  preferences: {
    themePresetId: 'library-classic',  // タスクB で使用
    // 将来: notifications, fontSize, ...
  },
  
  // メタ
  updatedAt: Timestamp,
}
```

- `profile` と `preferences` を分けることで、プロフィールと設定の責務を分離
- テーマは `preferences.themePresetId` に格納
- 将来の設定追加は `preferences` にフィールドを足すだけで済む

### 4.4 タスクの独立性

| タスク | 他タスクへの依存 | 単独でリリース可能か |
|--------|-----------------|---------------------|
| **A. 基盤** | なし | ✅ 基盤だけ先行リリース可能（その時点では theme はデフォルト固定） |
| **B. テーマ** | A 必須 | ✅ A 完了後、テーマだけ先行リリース可能 |
| **C. プロフィール** | A 必須 | ✅ A 完了後、プロフィールだけ先行リリース可能 |

---

## 5. オルタナティブ案との比較

### 案1: テーマを最優先（ユーザー設定基盤を最小限に）

- `users/{uid}` に `{ themePresetId }` だけを保存
- 専用の `useThemePreference` フック
- **メリット**: 着手が早い、工数が少ない  
- **デメリット**: 後からプロフィール等を足すとき、スキーマやフックの作り直しが発生しうる

### 案2: プロフィールを先に完成させる

- マイページを先に実装し、その中にテーマ設定を含める
- **メリット**: UI が一度でまとまる  
- **デメリット**: プロフィールの要件が固まるまでテーマを待つことになる

### 案3: 本提案（ユーザー設定基盤を先に整備）

- データ構造とフックを先に設計・実装
- 最初はテーマのみ利用し、後からプロフィールを追加
- **メリット**: 拡張しやすく、テーマ・プロフィールを柔軟に並行開発できる  
- **デメリット**: 基盤タスクの設計に少し時間がかかる

---

## 6. 結論と推奨

### 推奨: 案3（ユーザー設定基盤を先に整備）

1. **ユーザーデータ（プロフィール含む）の管理** を **タスクA: ユーザー設定の基盤** として切り出し、先行して整備する  
2. **テーマ選択** は **タスクB** とし、タスクA の `preferences` を利用して実装する  
3. **プロフィール** は **タスクC** とし、タスクA の `profile` を拡張する形で実装する  

この分離により：

- テーマは「ユーザー設定の一種」としてプロフィール等と整理された形で扱える  
- データ構造・フック・UI の置き場所を一度決めておける  
- テーマとプロフィールを、どちらを先に実装するか選択しやすい  

### タスクの粒度（目安）

| タスク | 概要 | 推定工数 |
|--------|------|---------|
| **A. ユーザー設定基盤** | スキーマ、useUserSettings、設定画面の土台、ルート追加 | 1〜2日 |
| **B. テーマ選択** | プリセット、ファクトリ、適用、選択UI（デザイン一元化込みで） | 3〜5日 |
| **C. プロフィール** | 表示名・アバターの表示・編集 | 1.5〜2日 |

---

## 7. bug-feature-memo への反映案

```
- [ ] **タスクA: ユーザー設定の基盤整備**
  - Firestore users/{userId} に profile, preferences 構造を設計
  - useUserSettings フック（取得・保存・更新）
  - 設定画面の土台（マイページ or 設定モーダル）
  - ボトムナビ PersonIcon のルート接続
  - 初回は preferences.themePresetId のみ利用

- [ ] **タスクB: テーマ選択機能**（タスクA に依存）
  - テーマプリセット、ファクトリ、ThemeProvider への動的適用
  - useUserSettings から themePresetId を読み反映
  - テーマ選択UI を設定画面に配置
  - デザイン一元化（パレット参照）との連携

- [ ] **タスクC: プロフィール機能**（タスクA に依存）
  - 表示名、アバターの表示・編集
  - 設定画面にプロフィールセクション追加
  - （旧 Phase 15-4 マイページをここに統合）
```

---

**関連ドキュメント**:
- `doc/theme-selectable-review-20260131.md` - テーマ選択実装の障壁分析
- `doc/implementation-cost-assessment-book-delete-profile.md` - プロフィールページのコスト評価
