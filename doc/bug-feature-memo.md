# バグ・改善案・TODOメモ

## バグ
- [x] メモ追加画面（書籍詳細画面）で、書籍のタグが表示されていない。（2024-06-27修正済み）
- [x] スマホでカメラ起動→バーコード読み取り機能がすぐ終了し、カメラ映像が表示されない（カメラ許可・ストリーム取得・UIバグ等の可能性あり）（2024-06-27修正済み）
- [x] 書籍詳細ページでタグの追加・修正・削除ができない（現状は表示のみ）。（2024-06-27修正済み）
  - BookAdd時のみタグ設定可能。編集機能を追加する場合はUI・Firestore更新処理の実装が必要。
- [x] 書籍詳細画面で、フッタメニューが画面の縦スクロールで画面外に消えて操作できなくなる。（2024-07-20発見、2024-07-20修正済み）
- [x] 書籍詳細画面の、一番上の書籍の情報表示が、縦書きになっていて、情報が正しく把握できないレイアウトになっている。（2024-07-20発見、2024-07-20修正済み）

## 機能追加・改善案
- [x] 書籍の追加日時、読了日時を表示したい。（2024-06-27修正済み）
- [x] メモの追加日時を表示したい。（2024-06-27修正済み）
- [x] メモの全文が表示されるので、メモが見づらい。リストはページや引用の先頭部分だけにして、メモの詳細は別ページにするかダイアログ・カードなどで表示されるようにしたい。（2024-06-27修正済み）

## 技術的課題・調査
- [x] 共通エラーダイアログをBookAdd以外の画面（BookDetail, MemoAdd, MemoList等）にも適用し、重要なエラーはsetGlobalErrorで通知するようリファクタ（2024-06-27修正済み）
- [ ] 統計・ダッシュボード機能の設計・技術調査、マイページ機能のUI設計、他サービス連携やデータエクスポートの検討
- [ ] **共通フックの作成（Phase 2）**: 重複コードの解消とコードの保守性向上（2024-07-20計画策定）

## 共通フック作成計画（Phase 2 - 2024-07-20策定）

**詳細は日報を参照**: [doc/daily-20240720.md#todo-phase-2-共通フック作成計画option-a---段階的アプローチ](doc/daily-20240720.md#todo-phase-2-共通フック作成計画option-a---段階的アプローチ)

### 🎯 **目的**
- 重複コードの解消（タグ履歴取得・保存処理の共通化）
- コードの保守性向上
- 開発効率の向上
- テストの安定性向上

### 📋 **方向性（Option A - 段階的アプローチ）**
- **段階的アプローチ**: 一度に多くの変更をせず、段階的に進める
- **リスク最小化**: 各ステップで動作確認を行い、問題があれば切り戻し可能
- **学習効果**: 段階的に理解を深めながら進める

### 🚀 **手順計画**

#### **Step 1: useTagHistory.js の作成（1日）**
**目的**: タグ履歴取得・保存の共通ロジックを抽出

**作業内容**:
1. `src/hooks/` ディレクトリの作成
2. `useTagHistory.js` の実装
   - `fetchTagHistory`: タグ履歴取得
   - `saveTagToHistory`: タグ履歴保存
   - 書籍用（`bookTagHistory`）とメモ用（`memoTagHistory`）の対応
3. 基本的なテストの作成

**対象コンポーネント**:
- `BookForm.jsx` (書籍用)
- `MemoAdd.jsx` (メモ用)
- `BookTagEditor.jsx` (書籍用)

#### **Step 2: コンポーネントの更新（1日）**
**目的**: 既存コンポーネントで共通フックを使用するよう更新

**作業内容**:
1. `BookForm.jsx` の更新（最初のテスト対象）
2. 動作確認とテスト
3. `MemoAdd.jsx` の更新
4. `BookTagEditor.jsx` の更新

#### **Step 3: テストと検証（1日）**
**目的**: 共通フックの動作確認とテストの更新

**作業内容**:
1. 各コンポーネントのテスト更新
2. 統合テストの実行
3. 動作確認とバグ修正

#### **Step 4: useBook.js の作成（1日）**
**目的**: 書籍取得・更新の共通ロジックを抽出

**作業内容**:
1. `useBook.js` の実装
   - `fetchBook`: 書籍取得
   - `updateBook`: 書籍更新
2. `BookDetail.jsx` での適用
3. テストの作成と更新

#### **Step 5: useMemo.js の作成（1日）**
**目的**: メモ取得・更新・削除の共通ロジックを抽出

**作業内容**:
1. `useMemo.js` の実装
   - `fetchMemos`: メモ一覧取得
   - `addMemo`: メモ追加
   - `updateMemo`: メモ更新
   - `deleteMemo`: メモ削除
2. `MemoList.jsx` での適用
3. テストの作成と更新

#### **Step 6: 全体のテストと検証（1日）**
**目的**: 全共通フックの統合テストと最終検証

**作業内容**:
1. 全テストの実行
2. 動作確認
3. パフォーマンス確認
4. ドキュメント更新

### 📊 **期待される効果**
- **コードの重複解消**: タグ履歴関連の重複コードを100%解消
- **保守性向上**: 共通ロジックの変更が一箇所で済む
- **開発効率向上**: 新しいコンポーネントでの実装が容易
- **テスト安定性**: 共通ロジックのテストが統一される

### ⚠️ **注意点**
- 既存機能に影響を与えないよう慎重に進める
- 各ステップで必ずテストを実行
- 問題が発生した場合は即座に切り戻し可能な状態を維持

### 📅 **スケジュール**
- **Day 1**: useTagHistory.js の作成
- **Day 2**: コンポーネントの更新
- **Day 3**: テストと検証
- **Day 4**: useBook.js の作成
- **Day 5**: useMemo.js の作成
- **Day 6**: 全体のテストと検証

### 🔄 **進捗管理**
- [ ] Step 1: useTagHistory.js の作成
- [ ] Step 2: コンポーネントの更新
- [ ] Step 3: テストと検証
- [ ] Step 4: useBook.js の作成
- [ ] Step 5: useMemo.js の作成
- [ ] Step 6: 全体のテストと検証

---

※この計画は2024年7月20日に策定され、Phase 2共通ロジックの抽出計画を記録しています。

## メモ表示・編集UI/UX改善（2024-06-27追記）
- [x] メモ一覧で「いつ追加したメモか」が分からない。追加日時を表示する。（2024-06-27修正済み）
- [x] メモ本文や引用が長い場合、1件の表示が大きすぎて一覧性が悪い。先頭数行だけ表示し、全文は詳細・ダイアログで見せる。（2024-06-27修正済み）
- [x] メモ本文や引用が長い場合、修正・削除ボタンが見えなくなる、フッターナビゲーションが隠れる等のUI崩れが発生する。カード化・高さ制限・スクロール等で改善。（2024-06-27修正済み）
- [x] メモ編集ウィンドウのレイアウト・デザインが悪い。横にはみ出す、エラーダイアログとデザインが統一されていない等。共通デザイン化・レイアウト修正。（2024-06-27修正済み）
- [x] 上記の各項目について、対応方針・実装状況・完了日などをこのメモで管理する。（2024-06-27修正済み）

## 修正内容詳細（2024-06-27）

### メモ追加画面のタグ表示バグ修正
- **修正内容**: 
  - BookDetail.jsx: 書籍のタグ情報をMemoAddコンポーネントに渡すように修正
  - MemoAdd.jsx: 受け取った書籍のタグを表示し、デフォルト値として設定
- **実装詳細**:
  - 書籍詳細画面で書籍のタグをChipコンポーネントで表示
  - メモ追加画面で「書籍のタグ:」として表示
  - メモ追加時のタグ入力欄に書籍のタグを初期値として設定
- **効果**: ユーザーが書籍のタグを確認しながらメモを追加できるようになった

### 共通エラーダイアログの拡張
- **修正内容**:
  - BookDetail.jsx: 書籍取得・ステータス更新エラーの通知
  - MemoAdd.jsx: タグ履歴取得・保存・メモ追加エラーの通知
  - MemoList.jsx: メモ一覧取得・更新・削除エラーの通知
- **実装詳細**:
  - ErrorDialogContextを使用したグローバルエラー通知
  - 各コンポーネントでtry-catch文にsetGlobalErrorを追加
  - ユーザーフレンドリーなエラーメッセージの設定
- **効果**: エラー処理の統一性向上、ユーザー体験の改善

### 書籍詳細ページのタグ編集機能
- **修正内容**:
  - BookDetail.jsx: タグ編集ダイアログの追加
  - タグ履歴取得・保存機能の実装
  - タグ編集UIの実装
- **実装詳細**:
  - タグ横の編集アイコンをクリックでダイアログを開く
  - Autocompleteコンポーネントでタグの追加・削除・編集
  - 書籍用タグ履歴（bookTagHistory）の管理
  - Firestoreでのタグ更新処理
- **効果**: 書籍のタグを後から編集できるようになった

## 修正内容詳細（2024-07-20）

### Phase 3 リファクタリングで発見された不具合

#### 1. フッタメニューのスクロール問題
- **問題**: 書籍詳細画面で、フッタメニューが画面の縦スクロールで画面外に消えて操作できなくなる
- **原因**: フッタメニューの固定位置設定が不適切、またはスクロール時の表示制御に問題
- **影響**: ユーザーがナビゲーションできなくなり、他の画面に移動できない
- **優先度**: 高（基本的なナビゲーション機能の障害）

#### 2. 書籍情報表示のレイアウト問題
- **問題**: 書籍詳細画面の一番上の書籍の情報表示が、縦書きになっていて、情報が正しく把握できないレイアウトになっている
- **原因**: CSS の writing-mode 設定やレイアウトの不適切な設定
- **影響**: ユーザーが書籍の基本情報（タイトル、著者、出版社など）を正しく読めない
- **優先度**: 中（表示の問題だが、基本機能に影響）

### 対応方針
1. **フッタメニュー問題**: 
   - フッタの固定位置設定を確認・修正
   - z-index の調整
   - スクロール時の表示制御の改善

2. **書籍情報レイアウト問題**:
   - CSS の writing-mode 設定を確認
   - レイアウトの方向性を横書きに修正
   - レスポンシブデザインの確認

### 修正内容詳細（2024-07-20）

#### 1. フッタメニューのスクロール問題修正
- **修正内容**: 
  - App.jsx: zIndex を 100 → 1000 に変更
  - App.jsx: 背景色とボーダーを追加
  - BookDetail.jsx: パディングを pb: '56px' → pb: '80px' に変更
- **効果**: フッタメニューが他の要素より前面に表示され、スクロール時も操作可能

#### 2. 書籍情報表示のレイアウト問題修正
- **修正内容**:
  - BookDetail.jsx: BookInfo と BookStatusChanger を縦並びに変更
  - BookInfo.jsx: 読書中表示を中央揃えに変更
  - BookInfo.jsx: 書籍情報を左揃えに変更
- **効果**: 書籍情報が縦に並び、読みやすいレイアウトになった

---

※バグ・細かい機能追加・技術的な疑問やTODOなど、思いついたことを随時ここにメモしてください。 