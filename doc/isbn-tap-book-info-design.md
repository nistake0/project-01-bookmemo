# ISBNタッチで書籍情報表示 - 設計検討

## 📋 概要

**機能要望**: ISBN をタッチしたときに自動で書籍情報を表示する

**現状**: 
- `BookInfo.jsx` で ISBN は `ISBN: {book.isbn}` としてプレーンテキスト表示
- タイトル・著者・出版社は `useTextCopyMenu` でタップ時にメニュー表示（コピー、Google検索、Amazon検索）
- ISBN にはインタラクションがなく、メニューも未適用

---

## 🎯 仕様の解釈と設計オプション

### 解釈の整理

| 観点 | 解釈A | 解釈B | 解釈C |
|------|-------|-------|-------|
| **「書籍情報」の内容** | 既存の書籍詳細（タイトル・著者・表紙等）を再表示 | 外部APIから取得した最新情報を表示 | 外部リンク（Amazon, 楽天等）へのショートカット |
| **「自動で」の意味** | タップだけで即時表示（メニューなし） | タップ→メニュー→選択で表示 | タップで取得開始しローディング後に表示 |
| **表示方式** | ポップオーバー／ツールチップ | ダイアログ | 既存のコンテキストメニュー拡張 |

---

## 📍 対象となる表示箇所

| 箇所 | 現状 | ISBNタップ時の期待 |
|------|------|-------------------|
| **BookInfo.jsx**（書籍詳細） | プレーン表示 | 書籍情報表示の主な対象 |
| **BookEditDialog.jsx** | ISBN表示あり | 同様の挙動を適用可能 |
| **メモ本文内** | ISBNが含まれる場合あり | 将来拡張: 本文中のISBNをリンク化してタップで表示 |

**Phase 1**: BookInfo を優先。他は後続で検討。

---

## 🛠 実装方式の比較

### 方式1: ポップオーバー／ツールチップ（即時表示）

**仕様**:
- ISBNタップ → その場にポップオーバーを表示
- 表示内容: 書影、タイトル、著者、出版社、外部リンクボタン群

**メリット**:
- タップ1回で表示
- 画面遷移なし
- 「自動で」のニュアンスに合う

**デメリット**:
- 書籍詳細画面では情報が重複
- モバイルでポップオーバーの表示領域が狭い可能性

**データソース**:
- オプションA: 既存の `book` をそのまま使用（API不要）
- オプションB: `useBookSearch.searchBookByIsbn` で再取得（最新の書影・説明文の取得が可能）

---

### 方式2: ダイアログ表示

**仕様**:
- ISBNタップ → 全画面またはモーダルダイアログで書籍情報を表示
- 書影（拡大）、タイトル、著者、出版社、出版日
- 外部リンク: Amazon、楽天ブックス、openBD、Google検索

**メリット**:
- 情報量を多く表示できる
- 書影の拡大表示がしやすい
- 外部リンクを整理して配置しやすい

**デメリット**:
- 閉じる操作が1回増える
- 書籍詳細と表示内容が重なりやすい

---

### 方式3: コンテキストメニュー拡張（現行UIに近い）

**仕様**:
- ISBN にも `useTextCopyMenu` を適用
- メニュー項目: **書籍情報を表示**（新規）、コピー、Amazon検索、楽天検索
- 「書籍情報を表示」選択時にポップオーバーまたはダイアログを表示

**メリット**:
- タイトル・著者・出版社と挙動を統一
- コピー・外部検索も引き続き利用可能
- 既存の `useTextCopyMenu` を拡張すれば実装しやすい

**デメリット**:
- 「自動で」とはやや異なり、メニュー選択が1ステップ増える

---

### 方式4: ISBNリンクコンポーネント（将来拡張）

**仕様**:
- メモ本文など、テキスト内のISBN（978-/979-など）を検出してリンク化
- タップで書籍情報ポップオーバー／ダイアログを表示
- メモテキスト改善の `LinkifiedText` と同様のパターン

**メリット**:
- メモ内の参考文献をタップで確認できる
- 既存書籍の有無もチェックしやすい

**デメリット**:
- ISBNの正規表現や検出ロジックが必要
- 表示箇所が増え、実装・保守コストが高い

---

## 🎨 推奨設計案

### 推奨: 方式1 + 方式3 のハイブリッド

**基本方針**:
1. **タップで即時表示**: ISBNタップ時にポップオーバーを表示（「自動で」を優先）
2. **コンテキストメニューも併用**: 長押し／右クリックで既存メニュー（コピー、外部検索）を表示

**表示内容（ポップオーバー）**:

```
┌─────────────────────────────┐
│ [書影]  タイトル             │
│        著者                  │
│        出版社 / 出版日       │
│  ───────────────────────   │
│  [Amazon] [楽天] [openBD]   │
│  [コピー]                   │
└─────────────────────────────┘
```

**データソース**:
- 初回は既存の `book` を使用（即時表示、API不要）
- オプションで「最新情報を取得」ボタンを配置し、タップ時に `useBookSearch` で再取得

**UI/UX**:
- ポップオーバー表示位置: ISBNの下、または画面幅に収まるよう自動調整
- 閉じ方: 外側クリック、Escキー、閉じるボタン
- ローディング: 再取得時のみスピナー表示
- タップ可能であることが分かるように、`cursor: pointer` や下線などの視覚的ヒントを付与

---

## 🔧 技術的検討事項

### 1. コンポーネント構成

```
BookInfo.jsx
  └─ IsbnDisplay.jsx (新規 or BookInfo内で実装)
        - タップ/長押しハンドラ
        - BookInfoPopover.jsx (ポップオーバー内容)
```

### 2. 既存リソースの再利用

- `useBookSearch.searchBookByIsbn(isbn)` … 外部API取得
- `useTextCopyMenu` … コピー・外部検索（ISBN向けに拡張 or ISBN専用で利用）
- `createSearchUrl` … Amazon/楽天の検索URL生成（ISBN検索用に拡張）

### 3. 外部リンクURL

| サービス | ISBN検索URL例 |
|---------|---------------|
| Amazon | `https://www.amazon.co.jp/s?k={isbn}` |
| 楽天ブックス | `https://books.rakuten.co.jp/isbn/{isbn}/` または `https://books.rakuten.co.jp/rb/Search?qt={isbn}` |
| openBD | `https://openbd.jp/isbn/{isbn}/` |
| Google Books | `https://www.google.com/search?q=isbn+{isbn}` |

### 4. パフォーマンス・API制限

- 既存データのみで表示する場合はAPI呼び出しなし
- 「最新情報を取得」は `useBookSearch` 経由（OpenBD → Google Books）
- 連打防止: 短時間での再取得を制限する簡単なデバウンスを検討

### 5. アクセシビリティ

- `role="button"` または適切な `aria-*` 属性
- キーボード操作（Enter/Space で表示）
- スクリーンリーダー用: 「ISBN: xxx。タップで書籍情報を表示」

---

## 📝 実装フェーズ案

### Phase 1: BookInfo の ISBN タップ対応

1. ISBN をタップ可能にする（`onClick` ハンドラ）
2. `BookInfoPopover` コンポーネント作成
   - 既存 `book` の情報を表示
   - 外部リンクボタン（Amazon, 楽天, openBD）
   - コピーボタン
3. 長押し／右クリックで `useTextCopyMenu` を適用（既存メニュー）
4. ユニットテスト追加

**所要時間の目安**: 2〜3時間

### Phase 2: 最新情報取得（オプション）

1. ポップオーバー内に「最新情報を取得」ボタンを追加
2. `useBookSearch.searchBookByIsbn` で再取得
3. ローディング表示とエラーハンドリング

**所要時間の目安**: 1〜2時間

### Phase 3: 他箇所への展開

1. `BookEditDialog` の ISBN にも同様の挙動を適用
2. （将来）メモ本文内の ISBN リンク化とタップでの表示

---

## ❓ 議論したいポイント

1. **「書籍情報」の範囲**  
   既存データのみでよいか、外部APIによる最新情報取得を標準にするか。

2. **表示方式**  
   ポップオーバー／ダイアログ／メニュー主体のどれを主とするか。

3. **「自動で」の定義**  
   タップ1回で即時表示を必須とするか、メニュー経由でも許容するか。

4. **対象箇所**  
   Phase 1 は BookInfo のみとするか、BookEditDialog も含めるか。

5. **外部リンク**  
   Amazon・楽天・openBD・Google のうち、どの組み合わせを初期表示するか。

---

**作成日**: 2025年1月31日  
**ステータス**: 設計検討中
